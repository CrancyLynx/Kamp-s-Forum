rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    /* ====================================================================
       FIREBASE CLOUD FIRESTORE GÜVENLİK KURALLARIVASI
       
       Güncelleme Tarihi: 2025-12-04
       Yazı: Backend Team
       
       TEMEL KULLANICI ROLLERİ:
       - Herkese açık (public): Gezdirme, arama
       - Oturum açmış (signed-in): Gönderi, sohbet, bildirim
       - Sahip (owner): Kendi verilerini düzenle
       - Admin (admin): Tüm sistem yönetimi
       - Sistem (system): Otomatik hoşgeldin mesajları
       
       TEMEL KURALLARI:
       1. Kimlik doğrulaması (Authentication)
       2. Yetkilendirme (Authorization)
       3. Alan seviyesi validation (Field-level)
       4. Veri bütünlüğü (Data integrity)
       ==================================================================== */
    
    // --- YARDIMCI FONKSİYONLAR ---
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Güvenlik: Kritik alanların değiştirilmesini engeller
    function checkRestrictedFields(fields) {
      return !('role' in fields) && 
             !('status' in fields) && 
             !('earnedBadges' in fields) && 
             !('verified' in fields);
    }
    
    function isSystemUser() {
      return isSignedIn() && 
             get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data.get('isSystem', false) == true;
    }

    // -----------------------------------------------------------
    // 1. KULLANICILAR KOLEKSİYONU
    // -----------------------------------------------------------
    match /kullanicilar/{userId} {
      // DÜZELTME: Kayıt olurken "bu takma ad kullanılıyor mu?" kontrolü için
      // okuma izninin herkese açık olması gerekir. Aksi takdirde kayıt engellenir.
      allow read: if true; 
      
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      allow update: if 
        isAdmin() ||
        (isOwner(userId) && checkRestrictedFields(request.resource.data.diff(resource.data).affectedKeys())) ||
        (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followers', 'followerCount', 'likeCount', 'commentCount', 'postCount', 'savedPosts', 'fcmTokens', 'blockedUsers', 'blockedByUsers', 'lastSeen', 'status']));
        
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // -----------------------------------------------------------
    // 2. GÖNDERİLER KOLEKSİYONU
    // -----------------------------------------------------------
    match /gonderiler/{postId} {
      allow read: if true;
      allow create: if isSignedIn(); // userId kontrolünü kodda yapıyoruz, burada esnetildi
      
      allow update: if 
        isAdmin() ||
        isOwner(resource.data.userId) || 
        // Beğeni, yorum sayısı ve sabitlenme durumları
        (isSignedIn() && (
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'commentCount', 'lastCommentTimestamp', 'recentCommenterAvatars', 'isPinned', 'voters', 'totalVotes', 'options'])
        ));
        
      allow delete: if isOwner(resource.data.userId) || isAdmin();
      
      // Yorumlar Alt Koleksiyonu
      match /yorumlar/{commentId} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update, delete: if isOwner(resource.data.userId) || isAdmin();
      }
    }
    
    // -----------------------------------------------------------
    // 3. SOHBETLER
    // -----------------------------------------------------------
    match /sohbetler/{chatId} {
      allow read: if resource == null || request.auth.uid in resource.data.participants;
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // Yazıyor... durumu için genel izin
      allow delete: if isAdmin();
      
      match /mesajlar/{messageId} {
         allow read: if isSignedIn(); // Basitleştirildi, üst koleksiyon zaten yetkiyi kontrol eder genelde
         allow create: if isSignedIn();
         allow update, delete: if isAdmin();
      }
    }

    // -----------------------------------------------------------
    // 4. DİĞER KOLEKSİYONLAR
    // -----------------------------------------------------------
    
    match /urunler/{productId} { 
      allow read: if true;
      allow create: if isSignedIn(); 
      allow update: if isOwner(resource.data.sellerId) || isAdmin() || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isSold']));
      allow delete: if isOwner(resource.data.sellerId) || isAdmin();
    }
    
match /{document=**} {
      allow read, write: if request.auth != null;
    }
    match /locations/{locationId} {
      allow read: if true;
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'lastUpdate', 'photos', 'votes', 'reviewCount', 'rating'])); // reviewCount eklendi
      
      // Mekan Yorumları
      match /reviews/{reviewId} {
        allow read: if true;
        allow create, update: if isSignedIn();
      }
    }
    
    match /etkinlikler/{eventId} { 
      allow read: if true;
      allow update: if isAdmin() || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attendees']));
      allow create, delete: if isAdmin();
    }
    
    match /bildirimler/{notificationId} { 
      allow read: if isOwner(resource.data.userId) || isAdmin(); 
      allow create: if isSignedIn() || isSystemUser(); // Sistem bildirim oluşturabiliyor
      allow update: if isOwner(resource.data.userId) || isAdmin() || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']));
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // Sistem kullanıcıları (Hoşgeldin maskotu vb)
    match /sistem_kullanicilar/{userId} {
      allow read: if true; // Herkese sistem kullanıcılarını görüntülemesine izin ver
      allow create, update, delete: if isAdmin();
    }
    
    match /sikayetler/{reportId} { 
      allow read, delete: if isAdmin();
      allow create: if isSignedIn(); 
    }
    
    match /degisiklik_istekleri/{requestId} { 
      allow read, update, delete: if isAdmin();
      allow create: if isSignedIn(); 
    }
    
    // Mesaj Ayarları (Sohbet stüdyosu özellikleri, notifikasyon tercihler vs)
    match /mesaj_ayarlari/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);
    }
    
    // Bildirim Ayarları (User notif preferences)
    match /bildirim_ayarlari/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);
    }
    
    // Engelli Kullanıcı Listesi (User blocks)
    match /bloke_edilenler/{blockingUserId}/{blockedUserId} {
      allow read: if isOwner(blockingUserId) || isAdmin();
      allow write: if isOwner(blockingUserId);
    }
    
    // İstatistikler
    match /statistics/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}