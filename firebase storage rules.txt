rules_version = '2';
service firebase.storage {
match /b/{bucket}/o {

// Yardımcı Fonksiyonlar
function isSignedIn() {
  return request.auth != null;
}

// Resim kontrolü: İçerik tipi resim olmalı ve boyutu 10MB'dan küçük olmalı
function isValidImage() {
  return request.resource.contentType.matches('image/.*')
         && request.resource.size < 10 * 1024 * 1024;
}

// Profil Resimleri
// Sadece kendi profil resmini (dosya adı kendi UID'si olan) yükleyebilir.
match /profil_resimleri/{userId}/{fileName} {
  allow read: if true;
  allow write: if isSignedIn() && request.auth.uid == userId && isValidImage();
}

// Gönderi, Yorum, Ürün, Anket ve Etkinlik Resimleri
// Yükleyen kullanıcının UID'sini içeren bir yola yazmayı zorunlu kılar.
match /{folder}/{userId}/{allPaths=**} {
  allow read: if true;
  allow write: if isSignedIn() && request.auth.uid == userId && isValidImage();
}

// Sohbet Resimleri
// Sadece sohbetin katılımcılarından biri resim yükleyebilir.
// Bu kural, sohbet belgesini okuyarak katılımcıları doğrular.
match /chat_images/{chatId}/{fileName} {
  function isChatParticipant() {
    return request.auth.uid in get(/databases/$(database)/documents/sohbetler/$(chatId)).data.participants;
  }
  
  allow read: if isSignedIn() && isChatParticipant();
  allow write: if isSignedIn() && isChatParticipant() && isValidImage();
}


}
}