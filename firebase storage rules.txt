rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    /* ====================================================================
       FIREBASE STORAGE GÜVENLİK KURALLARIVASI
       
       Güncelleme Tarihi: 2025-12-04
       Yazı: Backend Team
       
       KOLEKSİYON TÜRLERİ:
       1. Profil Resimleri: Herkese açık okuma, sahip yazma
       2. Gönderi Resimleri: Herkese açık okuma, sahip yazma
       3. Sohbet Resimleri: Sohbet katılımcılarına okuma, yazma
       4. Sistem Resimleri: Herkese açık okuma, backend yazma
       5. Badge/Achievement: Herkese açık, admin tarafından yönetilir
       
       DOSYA BOYUTU LIMITI: 10MB (isValidImage kontrolü)
       DOSYA TİPİ: İmaj dosyaları (image/*)
       ==================================================================== */

    // --- YARDIMCI FONKSİYONLAR ---
    function isSignedIn() {
      return request.auth != null;
    }

    // Not: Admin kontrolü Storage kurallarında Firestore okumayı gerektirir ve bazen yavaş olabilir.
    // Basitlik için burada sadece signedIn ve dosya sahipliği kontrolü yapacağız.

    function isValidImage() {
      return request.resource.contentType.matches('image/.*')
             && request.resource.size < 10 * 1024 * 1024; // Max 10MB
    }
    
    // Dosya adı "USERID-..." ile başlıyorsa veya "USERID.jpg" ise sahibidir.
    function isOwnerOfFile(fileName) {
      return fileName.matches(request.auth.uid + '.*');
    }

    // --- KURALLAR ---

    // 1. Profil Resimleri (Düzeltildi: Kodda direkt klasör içine atılıyor)
    // Kodun yolu: 'profil_resimleri/USERID.jpg'
    match /profil_resimleri/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isOwnerOfFile(fileName) && isValidImage();
      allow delete: if isSignedIn() && isOwnerOfFile(fileName);
    }
    
    // Sistem kullanıcılarının profil resimleri (Maskotur resmi)
    match /sistem_profil_resimleri/{fileName} {
      allow read: if true;
      allow write: if false; // Sadece backend Cloud Functions tarafından yazılır
      allow delete: if false;
    }

    // 2. Gönderi Resimleri
    match /gonderi_resimleri/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isOwnerOfFile(fileName) && isValidImage();
      allow delete: if isSignedIn() && isOwnerOfFile(fileName);
    }

    // 3. Yorum Resimleri
    match /yorum_resimleri/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isOwnerOfFile(fileName) && isValidImage();
      allow delete: if isSignedIn() && isOwnerOfFile(fileName);
    }
    
    // Ürün Yorumu Resimleri
    match /urun_yorum_resimleri/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isOwnerOfFile(fileName) && isValidImage();
      allow delete: if isSignedIn() && isOwnerOfFile(fileName);
    }

    // 4. Ürün Resimleri
    match /urun_resimleri/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isValidImage();
      allow delete: if isSignedIn() && isOwnerOfFile(fileName);
    }

    // 5. Sohbet Resimleri (Klasörlü yapı: chat_images/CHATID-USERID-TIMESTAMP.jpg)
    match /chat_images/{fileName} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && isValidImage() && fileName.matches('.*-' + request.auth.uid + '-.*');
      allow delete: if isSignedIn() && fileName.matches('.*-' + request.auth.uid + '-.*');
    }
    
    // 6. Anket Resimleri
    match /anket_resimleri/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isOwnerOfFile(fileName) && isValidImage();
    }
    
    // 7. Etkinlik Resimleri (Sadece Admin ekler)
    match /events/{fileName} {
      allow read: if true;
      allow write: if false; // Sadece backend Cloud Functions
      allow delete: if false;
    }
    
    // 8. Bildirim İkonları (Sistem tarafından kullanılan)
    match /notification_icons/{fileName} {
      allow read: if true;
      allow write: if false; // Sadece backend
    }
    
    // 9. Mekan Fotoğrafları (Location/Map Service)
    match /location_photos/{locationId}/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isValidImage(); // User-generated content
      allow delete: if isSignedIn(); // Kendi fotoğraflarını silebilir
    }
    
    // 10. Badge ve Achievement İkonları
    match /badges/{fileName} {
      allow read: if true;
      allow write: if false; // Sadece admin
    }
    
    // 11. Ring Seferleri / Ulaşım Tarifeleri
    match /ulasim_tarifeleri/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isValidImage();
      allow delete: if isSignedIn() && isOwnerOfFile(fileName);
    }
    
    // 12. Etkinlik Afişleri
    match /etkinlik_afisleri/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isOwnerOfFile(fileName) && isValidImage();
      allow delete: if isSignedIn() && isOwnerOfFile(fileName);
    }
    
    // 13. Moderasyon İçeriği (İçerik incelemeleri, şüpheli dosyalar)
    match /moderasyon_resimleri/{fileName} {
      allow read: if false; // Sadece backend
      allow write: if false; // Sadece backend
    }
    
    // 14. Ring Sistemi - Grup/Kapak Fotoğrafı
    match /ring_resimleri/{ringId}/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isValidImage(); // Ring üyeleri yükleyebilir
      allow delete: if isSignedIn(); // Kendi yüklediklerini silebilir
    }
    
    // 15. Ring Sistemi - Sefer Zamanı Fotoğrafı (Gerçek zamanlı ring seferleri)
    match /ring_sefer_resimleri/{ringId}/{sefarId}/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isValidImage();
      allow delete: if isSignedIn();
    }
    
    // 16. Ring Sistemi - İlan/Duyuru Fotoğrafı
    match /ring_duyuru_resimleri/{ringId}/{duyuruId}/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isValidImage();
      allow delete: if isSignedIn();
    }
    
    // 17. Beklemede Ring Sefer Fotoğrafları (Admin onayı bekleniyor)
    match /pending_ring_photos/{universityName}/{fileName} {
      allow read: if false; // Sadece backend (admin panel direct firestore okur)
      allow write: if isSignedIn() && isValidImage(); // Kullanıcı yükleme yapabilir
      allow delete: if false; // Sadece admin silebilir
    }
    
    // 18. Etkinlik/Forum Banner Resimleri
    match /forum_banners/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isOwnerOfFile(fileName) && isValidImage();
      allow delete: if isSignedIn() && isOwnerOfFile(fileName);
    }
    
    // 19. Kullanıcı Rozet/Badge Görselleri
    match /user_badges/{userId}/{badgeId} {
      allow read: if true;
      allow write: if false; // Sadece backend tarafından (sistem tarafından kazanılır)
      allow delete: if false;
    }
    
    // 20. Harita/Mekan İkon Resimleri
    match /location_markers/{fileName} {
      allow read: if true;
      allow write: if false; // Sadece backend
      allow delete: if false;
    }
    
    // 21. İçerik Moderasyon Resimleri
    match /moderated_content/{fileName} {
      allow read: if false; // Sadece admin/moderatör
      allow write: if false; // Sadece system functions
      allow delete: if false;
    }
    
    // 22. Yedek / Arşiv Resimleri (Silinmiş içerik)
    match /archive/{fileName} {
      allow read: if false; // Sadece admin
      allow write: if false; // Sadece system functions
      allow delete: if false;
    }
    
    // 23. Hızlı Mesajlar İçin Emoji/Sticker
    match /emojis/{fileName} {
      allow read: if true;
      allow write: if false; // Sadece admin
      allow delete: if false;
    }
    
    // 24. Anket Banner Resimleri
    match /poll_banners/{pollId}/{fileName} {
      allow read: if true;
      allow write: if isSignedIn() && isValidImage();
      allow delete: if isSignedIn();
    }
    
    // ⚠️ CATCH-ALL RULE - Tüm kalan istekler reddi (GÜVENLİ VERSİYON)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}